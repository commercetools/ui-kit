# Visual regression testing with Puppeteer and Percy

We use visual regression testing to avoid inadvertently introducing visual regressions.

This works by taking screenshots of our components in different states. When changes are made, they get compared to the baseline on CI by [Percy](https://percy.io/). In case changes are detected, the CI check will fail unless somebody approves the changes on the Percy website.

## Constraints

### How to write visual regressions tests

#### Create files ending in `.visualroute.js`

Our `visual-testing-app` detects all files ending in `.visualroute.js`, and creates a route for each of these files. We can then use these routes in our test files ending in `visualspec.js`

#### Write tests in ending `.visualspec.js`

We use a library called [jest-puppeteer](https://github.com/smooth-code/jest-puppeteer) to run our visual tests. We use puppeteer to navigate to routes generated by our `*.visualroute.js` files, and then we use a tool called [Percy](https://percy.io/) to take snapshots of that route.

### Why we test the bundle

We use the bundled ui-kit to ensure that rollup bundling is working well. This allows us to quickly ensure changes to the rollup build don't break the visuals of our components.

### Why we group multiple states into one snapshot

When writing visual regression tests we need to ensure that we stay within our monthly budget of visual diffs on Percy. Every time a screenshot is taken for a specific browser and a specific viewport it counts as one _visual diff_. Another factor to consider is that we want to ensure that Percy completes in a timely manner. Taking one snapshot takes around 3 seconds. If we take one snapshot for every state of every component, then it quickly adds up to over 45 minutes to complete a single test run. We therefore render one component in many states in a single snapshot. We also limit ourselves to one browser and one viewport size to reduce the number of visual diffs created per test run.

## Adding Visual Regression Routes

Below is an example of how to add Visual Regression Route to the Visual Testing Playground. This section also demonstrates the components we've built to ease writing tests.

All visual routes must import from the bundled ui-kit. This rule is introduced to ensure that the rollup build chain is tested as well - which gives us more confidence when making changes to rollup itself.

```js
// primary-button.visualroute.js

import React from 'react';
import { InformationIcon, PrimaryButton } from 'ui-kit';
import { Suite, Spec } from '../../../../test/percy';

export const routePath = '/primary-button';

export const component = () => (
  <Suite>
    <Spec label="in default state">
      <PrimaryButton label="Primary button" />
    </Spec>
    <Spec label="when disabled">
      <PrimaryButton disabled={true} label="Primary button" />
    </Spec>
  </Suite>
);
```

You can see your route by running `yarn visual-testing-app:build` and `yarn visual-testing-app:serve` and then navigating to your defined routePath.

## Adding Visual Regression Tests

Below is an example of how to add Visual Regression Test.

```js
// primary-button.visualspec.js

import { percySnapshot } from '@percy/puppeteer';

describe('PrimaryButton', () => {
  beforeAll(async () => {
    await page.goto(`${HOST}/primary-button`);
  });

  it('PrimaryButton', async () => {
    await expect(page).toMatch('A label text');
    await percySnapshot(page, 'PrimaryButton');
  });
});
```

You can run your test by running `yarn test:visual`. Notice how before we call `percySnapshot`, we add an expect assertion on some text on the page. This is to ensure that the tests will fail if your route cannot be found. Otherwise, we could end up uploading a lot of `route not founds` to Percy.

### `Suite`

The `Suite` sets up the context (`react-intl`) for the tests. It should always be rendered even when your component doesn't access these things.

You should only use one `Suite` per `screenshot` as there is no point in defining multiple `Suites` since you only need the context to be set up once (usually). An exception might be if you want to render your component in multiple locales.

### `Spec`

A `Spec` should render your component in a specific state.

You can use multiple specs within a `Suite`.

## Local development (rarely used)

### Viewing snapshots in browser

You can run `yarn visual-testing-app:build` and `yarn visual-testing-app:serve` to show your routes in the browser without having to upload them. This is useful when you're working on adding more snapshots or resolving bugs in existing snapshots.

No snapshots will be uploaded to Percy in this case.

### Uploading local snapshots

Usually, you'd let Percy run for your PRs on CI. There is no need to run it locally. However, if you ever need to run Percy locally (e.g. to debug our Percy setup), you can follow the steps described [here](https://docs.percy.io/docs/local-development).

In short:

```bash
# Get the token from ui-kit's settings on percy.io
export PERCY_TOKEN=aaabbbcccdddeeefff
# Set the branch to local so that it uses the correct baseline
export PERCY_BRANCH=local

# build the visual testing playground app so your visual routes are available.
yarn visual-testing-app:build
# Run percy. Once it's done it will print a URL where you
# can review the visual diffs.
yarn percy
```

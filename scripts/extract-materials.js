const fs = require('fs');
const path = require('path');
const prettier = require('prettier');
const rcfile = require('rcfile');
const postcss = require('postcss');
const postcssDiscardComments = require('postcss-discard-comments');
const postcssColorModFunction = require('postcss-color-mod-function');
const postcssCustomProperties = require('postcss-custom-properties');
const cssvariables = require('postcss-css-variables');
const postcssImport = require('postcss-import');

const relativePath = path.join(__dirname, '../materials/internals');
const exportPath = path.join(__dirname, '../materials');
const importPath = path.join(__dirname, '../materials/internals/index.css');

const css = fs.readFileSync(importPath, 'utf8');

const commentDoNotModify = `/* THIS IS AN AUTOGENERATED FILE. DO NOT EDIT THIS FILE DIRECTLY.
  This file is created by the 'scripts/extract-materials.js' script. The real
  values of the variables should be updated in '${relativePath}' */ \n
  ;
  `;

postcss([
  postcssImport(),
  postcssDiscardComments(),
  postcssColorModFunction(),
  // to transform the imported :roots to actual values
  cssvariables({
    preserve: 'computed',
  }),
  // to export variables to css and js files
  postcssCustomProperties({
    preserve: false,
    exportTo: [`${exportPath}/imports.css`, `${exportPath}/imports.js`],
  }),
])
  .process(css, { from: importPath })
  .then(
    () => {
      const prettierConfig = rcfile('prettier');
      const exportedJs = fs.readFileSync(`${exportPath}/imports.js`, 'utf8');
      const exportedCss = fs.readFileSync(`${exportPath}/imports.css`, 'utf8');
      // format the files with prettier
      fs.writeFileSync(
        `${exportPath}/imports.js`,
        prettier.format(`${commentDoNotModify}${exportedJs}`, prettierConfig)
      );
      fs.writeFileSync(
        `${exportPath}/imports.css`,
        prettier.format(`${commentDoNotModify}${exportedCss}`, {
          ...prettierConfig,
          parser: 'scss',
        })
      );
      // eslint-disable-next-line no-console
      console.log(`Materials extracted to \n ${exportPath}`);
    },
    err => {
      // eslint-disable-next-line no-console
      console.log(`Error extracting css`, err);
    }
  );

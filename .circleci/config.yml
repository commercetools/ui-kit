version: 2.1

aliases:
  - &working_directory ~/ui-kit

  - &restore_yarn_cache
    restore_cache:
      name: 'Restoring yarn cache'
      keys:
        - v1-yarn-cache-{{ .Branch }}-{{ checksum "yarn.lock" }}
        - v1-yarn-cache-{{ .Branch }}
        - v1-yarn-cache

  - &save_yarn_cache
    save_cache:
      name: 'Saving yarn cache'
      key: v1-yarn-cache-{{ .Branch }}-{{ checksum "yarn.lock" }}
      paths:
        - ~/.cache/yarn

  - &run_yarn
    run: yarn --frozen-lockfile

executors:
  node_13:
    docker:
      - image: circleci/node:13.10
    working_directory: *working_directory

commands:
  setup_dependencies:
    description: Installing dependencies
    steps:
      - checkout
      - *restore_yarn_cache
      - *run_yarn
  save_package_bundles:
    steps:
      - persist_to_workspace:
          root: *working_directory
          paths:
            - design-system/dist/
            - packages/*/dist/
            - packages/components/*/dist/
            - packages/components/buttons/*/dist/
            - packages/components/fields/*/dist/
            - packages/components/inputs/*/dist/
            - packages/components/spacings/*/dist/
            - presets/*/dist/
  restore_package_bundles:
    steps:
      - attach_workspace:
          at: *working_directory
  build_packages:
    description: Building packages
    steps:
      - run: yarn build
  lint_and_test:
    description: 'Running linters and tests'
    steps:
      - run:
          name: Running linters and tests
          command: yarn run jest --projects jest.{eslint,stylelint,test,bundle}.config.js --maxWorkers=3 --reporters jest-silent-reporter
  vrt_test:
    description: 'Running Visual Regression Tests'
    steps:
      - run:
          name: Update
          working_directory: *working_directory
          command: |
            sudo apt-get update -y
      - run:
          name: Update
          working_directory: *working_directory
          command: |
            sudo apt-get upgrade -y
      - run:
          name: Install Chrome headless dependencies
          working_directory: *working_directory
          command: |
            sudo apt-get install -yq gconf-service libasound2 libatk1.0-0 libc6 libcairo2 libcups2 libdbus-1-3 \
            libexpat1 libfontconfig1 libgcc1 libgconf-2-4 libgdk-pixbuf2.0-0 libglib2.0-0 libgtk-3-0 libnspr4 \
            libpango-1.0-0 libpangocairo-1.0-0 libstdc++6 libx11-6 libx11-xcb1 libxcb1 libxcomposite1 \
            libxcursor1 libxdamage1 libxext6 libxfixes3 libxi6 libxrandr2 libxrender1 libxss1 libxtst6 \
            ca-certificates fonts-liberation libappindicator1 libnss3 lsb-release xdg-utils wget --fix-missing
      - run:
          name: Bulding visual testing app
          command: yarn visual-testing-app:build
      - run:
          name: Running Percy against visual testing app
          command: ./scripts/run-percy.sh
      - run:
          name: Checking bundle size of visual testing app
          command: yarn bundlesize
  publish:
    description: Publishing to npm registry
    steps:
      - run: ./scripts/release_canary.sh

jobs:
  build_lint_and_test:
    executor: node_13
    steps:
      - setup_dependencies
      - *save_yarn_cache
      - build_packages
      - lint_and_test
      - vrt_test
      - save_package_bundles
  publish:
    executor: node_13
    steps:
      - setup_dependencies
      - restore_package_bundles
      - publish

workflows:
  version: 2
  build_and_test:
    jobs:
      - build_lint_and_test:
          filters:
            tags:
              only: /v[\.0-9]+.*/
      - publish:
          requires:
            - build_lint_and_test
          filters:
            branches:
              only:
                - master
                - ml-mono
